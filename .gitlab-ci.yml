# Ensure if the safedep/vet/scan component is available
include:
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/scan@$CI_COMMIT_SHA
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/sbom@$CI_COMMIT_SHA

stages: [test, release]

variables:
  # make sure its same as the job name in the template/scan.yml & template/sbom.yml
  SCAN_JOB_NAME_DEPENDENCY_SCANNING: "vet_dependency_scanning"
  SCAN_JOB_NAME_SBOM: "vet_sbom"

# Ensure that are able to load the dependency scanning component
ensure_job_template_dependency_scanning:
  stage: test
  image: badouralix/curl-jq
  script:
    - echo "Expect that a job named '$SCAN_JOB_NAME_DEPENDENCY_SCANNING' is added to the pipeline"
    - |
      route="${CI_API_V4_URL}/projects/$CI_PROJECT_ID/pipelines/$CI_PIPELINE_ID}/jobs"
      if curl --silent --header "JOB-TOKEN: $CI_JOB_TOKEN" $route | jq -e "any(.name | contains(\"$SCAN_JOB_NAME_DEPENDENCY_SCANNING\"))" > /dev/null; then
        echo "Component Job '$SCAN_JOB_NAME_DEPENDENCY_SCANNING' is present"
      else
        echo "Component Job '$SCAN_JOB_NAME_DEPENDENCY_SCANNING' is not present"
        exit 1
      fi
  rules:
    - if: ($CI_COMMIT_BRANCH || $CI_COMMIT_TAG) && $CI_SERVER_HOST =~ /gitlab.com/


# Ensure that are able to load the sbom component
ensure_job_template_sbom:
  stage: test
  image: badouralix/curl-jq
  script:
    - echo "Expect that a job named '$SCAN_JOB_NAME_SBOM' is added to the pipeline"
    - |
      route="${CI_API_V4_URL}/projects/$CI_PROJECT_ID/pipelines/$CI_PIPELINE_ID}/jobs"
      if curl --silent --header "JOB-TOKEN: $CI_JOB_TOKEN" $route | jq -e "any(.name | contains(\"$SCAN_JOB_NAME_SBOM\"))" > /dev/null; then
        echo "Component Job '$SCAN_JOB_NAME_SBOM' is present"
      else
        echo "Component Job '$SCAN_JOB_NAME_SBOM' is not present"
        exit 1
      fi
  rules:
    - if: ($CI_COMMIT_BRANCH || $CI_COMMIT_TAG) && $CI_SERVER_HOST =~ /gitlab.com/

# Ensure that a project description exists, because it will be important to display
# the resource in the catalog.
check-description:
  image: badouralix/curl-jq
  script:
    - |
      route="$CI_API_V4_URL/projects/$CI_PROJECT_ID"
      desc=`curl --silent $route | jq '.description'`
      if [ "$desc" = "null" ]; then
        echo "Description not set. Please set a projet description"
        exit 1
      else
        echo "Description set"
      fi
  rules:
    - if: $CI_SERVER_HOST =~ /gitlab.com/


# Ensure that a `README.md` exists in the root directory as it represents the
# documentation for the whole components repository.
check-readme:
  image: busybox
  script: ls README.md || (echo "Please add a README.md file" && exit 1)


# Rlease is Required (specialy `release` keyword) for publishing CI Component To CI / CD Catalog
# See: https://docs.gitlab.com/ci/components/#publish-a-new-release
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script: echo "Creating release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG of components repository $CI_PROJECT_PATH"
